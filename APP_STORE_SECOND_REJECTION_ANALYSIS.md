# App Store 再リジェクト対応まとめ

## リジェクト日時
- 審査日: 2025年12月23日
- Submission ID: d2af0951-50cd-411e-8afc-d30d598edfed
- バージョン: 3.0
- デバイス: iPhone 14, iPad Air 11-inch (M2)

---

## 問題1: Guideline 5.1.2 - クッキーとトラッキング

### 指摘内容
- アプリがアクセスするWebコンテンツでクッキーを収集している
- クッキーがトラッキングに使用される可能性があるが、App Tracking Transparencyの許可を求めていない

### 原因分析
おそらく以下のいずれかが原因：
1. Capacitorアプリ内のWebViewがクッキーを使用している
2. 外部リンク（Instagram、Twitter、TikTokなど）がクッキープロンプトを表示している
3. プロフィール画像のアップロード時に外部サービスを使用している

### 対応方針：オプションA（推奨）- クッキープロンプトを削除
**実装難易度：低**

#### 対応内容
1. WebViewのクッキー使用を無効化または制限
2. 外部リンク（SNS）を外部ブラウザで開くように変更
3. プライバシーポリシーを更新して、クッキーを使用しないことを明記

#### 実装箇所
- Capacitor設定（capacitor.config.ts）
- SNSリンクのクリックハンドラー

### 対応方針：オプションB - App Tracking Transparencyを実装
**実装難易度：高（非推奨）**

トラッキングを行っていない場合、この対応は不要です。

---

## 問題2: Guideline 2.1 - アプリクラッシュ

### 指摘内容
- アプリがクラッシュした
- クラッシュ手順：
  1. アプリ起動・ログイン
  2. ユーザーアバタータップ
  3. 「プロフィール画像を変更」タップ
  4. 「画像をアップロード」タップ
  5. 「Take Photo」タップ → **クラッシュ**

### 原因分析
カメラアクセス時にクラッシュしている可能性が高い。

**考えられる原因：**
1. **カメラ権限の説明文（NSCameraUsageDescription）が未設定**
2. カメラプラグインが正しく設定されていない
3. iOS 18での権限処理の変更

### 対応方針：Info.plistにカメラ権限の説明を追加

#### 対応内容
`ios/App/App/Info.plist`に以下を追加：

```xml
<key>NSCameraUsageDescription</key>
<string>プロフィール画像を撮影するためにカメラへのアクセスが必要です</string>
<key>NSPhotoLibraryUsageDescription</key>
<string>プロフィール画像を選択するためにフォトライブラリへのアクセスが必要です</string>
```

#### 確認方法
1. Xcodeでシミュレーターまたは実機で同じ手順を実行
2. カメラアクセス時にクラッシュしないことを確認

---

## 問題3: Guideline 1.2 - ユーザー生成コンテンツのモデレーション

### 指摘内容
前回の対応（利用規約の整備）では不十分。以下の機能実装が必須：
1. **不適切なコンテンツを通報する機能**
2. **ユーザーをブロックする機能**
   - ブロック時に開発者に通知
   - フィードから即座に削除

### 対応方針：通報・ブロック機能の実装（必須）

**実装難易度：中**

#### 必要な機能

##### 1. ユーザー通報機能
**実装箇所：** 他ユーザーのプロフィール画面

- 「通報」ボタンを追加
- 通報理由を選択（スパム、不適切な内容、ハラスメント、など）
- 通報内容をデータベースに保存
- 管理者にメール通知（オプション）

**データベース構造：**
```sql
CREATE TABLE reports (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  reporter_id UUID REFERENCES users(id) NOT NULL,
  reported_user_id UUID REFERENCES users(id) NOT NULL,
  reason TEXT NOT NULL,
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

##### 2. ユーザーブロック機能
**実装箇所：** 他ユーザーのプロフィール画面

- 「ブロック」ボタンを追加
- ブロックしたユーザーをデータベースに記録
- ブロックしたユーザーをUIから即座に非表示
- ブロックリスト管理画面（設定画面など）

**データベース構造：**
```sql
CREATE TABLE blocks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  blocker_id UUID REFERENCES users(id) NOT NULL,
  blocked_user_id UUID REFERENCES users(id) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(blocker_id, blocked_user_id)
);
```

**フィードからの除外：**
- ライブ参加者リストでブロックしたユーザーを非表示
- フォロワー/フォロイングリストで非表示
- ホーム画面でブロックしたユーザーのライブを非表示

---

## 対応優先順位

### 🔴 最優先（クラッシュ対応）
**問題2: カメラ権限の設定**
- 所要時間: 5分
- 難易度: 低
- 影響: クラッシュでアプリが使用不可

### 🟡 必須（機能実装）
**問題3: 通報・ブロック機能**
- 所要時間: 3-5時間
- 難易度: 中
- 影響: 審査通過に必須

### 🟢 重要（設定変更）
**問題1: クッキー対応**
- 所要時間: 30分-1時間
- 難易度: 低
- 影響: プライバシー対応

---

## 実装手順

### ステップ1: カメラ権限の追加（5分）
1. `ios/App/App/Info.plist`を編集
2. カメラとフォトライブラリの説明文を追加
3. Xcodeで実機テスト

### ステップ2: クッキー対応（30分）
1. Capacitor設定でクッキーを制限
2. SNSリンクを外部ブラウザで開くように変更
3. プライバシーポリシーを更新

### ステップ3: 通報・ブロック機能の実装（3-5時間）

#### 3-1. データベース設計（30分）
- Supabaseでテーブル作成（reports, blocks）
- RLSポリシー設定

#### 3-2. API実装（1時間）
- `reportUser()` - ユーザー通報
- `blockUser()` - ユーザーブロック
- `unblockUser()` - ブロック解除
- `getBlockedUsers()` - ブロックリスト取得
- `isBlocked()` - ブロック状態確認

#### 3-3. UI実装（2-3時間）
- プロフィール画面に通報ボタン追加
- プロフィール画面にブロックボタン追加
- 通報ダイアログ作成
- ブロック確認ダイアログ作成
- ブロックリスト管理画面（設定）
- フィードからブロックユーザーを除外

#### 3-4. テスト（30分）
- 通報機能のテスト
- ブロック機能のテスト
- UI更新の確認

---

## 次のアクション

1. **即座に対応：カメラ権限の追加**
2. **優先対応：通報・ブロック機能の実装**
3. **補完対応：クッキー制限の設定**
4. **再テスト：全機能の動作確認**
5. **再申請：App Store Connect経由**

---

## 推定所要時間

- 最小構成（カメラ権限のみ）: 5分
- 推奨構成（全対応）: **4-6時間**

---

## オプション1: 最小限の対応で再申請（非推奨）

カメラ権限のみ追加して再申請し、通報・ブロック機能は「実装予定」と説明する。

**リスク：** 再度リジェクトされる可能性が高い

## オプション2: 完全対応してから再申請（推奨）

3つの問題すべてに対応してから再申請する。

**メリット：** 審査通過の確率が高い
**デメリット：** 実装に時間がかかる（4-6時間）

---

## 推奨アプローチ

**オプション2（完全対応）を推奨します。**

理由：
1. 問題3（通報・ブロック機能）は「必須」と明記されている
2. 中途半端な対応では再度リジェクトされる
3. 一度実装すれば、今後の審査で問題にならない

---

## 実装支援が必要な項目

以下の実装について、サポートが必要であればお知らせください：

1. ✅ カメラ権限の追加（Info.plist）- すぐに対応可能
2. ✅ クッキー制限の設定（Capacitor設定）- すぐに対応可能
3. ❓ 通報・ブロック機能の実装 - フルサポート可能

どのアプローチで進めますか？
